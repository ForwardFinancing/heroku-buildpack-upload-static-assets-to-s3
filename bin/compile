#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps



### Configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

### Constants
AWS_CLI_URL="https://s3.amazonaws.com/aws-cli/awscli-bundle.zip"
AWS_CLI_ZIP_LOCATION="$CACHE_DIR/awscli-bundle.zip"
VENDOR_DIR="$CACHE_DIR/vendor"

### Load dependencies
source ${BP_DIR}/lib/output.sh

header "Installing AWS CLI"

curl --progress-bar -o ${AWS_CLI_ZIP_LOCATION} ${AWS_CLI_URL}
unzip -qq -d ${VENDOR_DIR} ${AWS_CLI_ZIP_LOCATION}
${VENDOR_DIR}/awscli-bundle/install -b ~/bin/aws & printf 'y'

header "Installed AWS CLI"
info $(/app/bin/aws --version)
